<!DOCTYPE html>
<html data-bs-theme="dark">

<head>
    <title>hairpinDB</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <link rel="icon" type="img/x-icon" href="/img/favicon.ico">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/2.0.8/css/dataTables.bootstrap5.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/2.0.8/js/dataTables.js"></script>
    <script src="https://cdn.datatables.net/2.0.8/js/dataTables.bootstrap5.js"></script>
    <script src="js/functions.js"></script>

    <style>
        .homepage-container {
            font-size: xx-large;
            font-family: monospace;
            display: flex;
            flex-direction: row;
            justify-content: center;
            align-items: "center";
            padding-left: 3%;
            padding-right: 3%;
            padding-top: 3%
        }

        .penn-logo {
            width: 18%;
            height: 18%;

        }

        .charts-container {
            margin-left: 5%;
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
        }

       

        #legend {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-right: 20px;
            font-family: monospace;
            background-color: #1b1e22;
            padding: 5px;
            border-radius: 10%;
        }

        .legend-item:hover {
            opacity: 0.8;
            cursor: pointer;

        }


        .legend-item span {
            margin-left: 5px;
            font-size: 15px;
        }

        .tooltip {
            position: absolute;
            text-align: center;
            width: 60px;
            height: 28px;
            padding: 2px;
            font: 12px sans-serif;
            background: #f0f0f0;
            border: 1px solid #aaa;
            border-radius: 8px;
            pointer-events: none;
            opacity: 0;
        }

        .bar {
            fill: steelblue;
        }

        .bar:hover {
            fill: brown;
        }

        .histogram-tooltip {
            position: absolute;
            text-align: center;
            padding: 6px;
            font: 12px sans-serif;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            pointer-events: none;
        }

        .chart-title {
            font-size: 20px;
        }

        .container {
            padding-left: 3%;
            padding-right: 3%;
            padding-top: 3%;
            display: flex;
            flex-direction: row;
            justify-content: space-between;
        }

        .column {
            flex: 1;
            margin: 0 1%;
        }

        .main-container {
            font-family: monospace;
        }
    </style>
</head>

<body>

    <div id="navbar-container"></div>
    <div class="main-container">
        <!-- <div class="homepage-container">
            <img class='penn-logo' src="img/penn_logo.png"></img>
        </div> -->
        
        <div class="homepage-container">
            

            <h1>hairpinDB</h1>
        </div>
        <div class="homepage-container">
            <img class='penn-logo' src="img/hairpin_loop_cropped.png"></img>
        </div>

        <div class="homepage-container">
            <h1><b>118,072 </b>genomes analyzed.</h1>
        </div>
        
        <div class="homepage-container">
            <h1><b>31,449,295 Inverted Repeats in total across organisms</b></h1>
        </div>

        <br>
        <br>
        <br>
        <br>
        <br>


        <div class="homepage-container">
            <h1>
                <div class="chart chart-title" style="font-size: 2rem;">Distribution of Inverted Repeats <b>Density</b> per domain:</div>

            </h1>
        </div>
        <br>
        <div class="homepage-container">
            <div id="chart1" class="chart"></div>
        </div>
        <br>
        <br>
        <div id="legend"></div>

        <br>
        <br>
        <br>

        <div class="container">
            <div class="column">
                <div class="homepage-container">
                    <h1>Top 10 most frequent Unit Sequences:</h1>
                </div>
                <div class="homepage-container">
                    <table id="topten-unit-table" class="display table table-striped table-hover dataTable"
                        style="table-layout: auto; width: 90%;" aria-describedby="example_info">
                        <thead>
                            <tr role="row" id="topten-unit-table-header">
                                <th>Unit Sequence</th>
                                <th>Occurences</th>
                            </tr>
                        </thead>
                        <tbody id="topten-unit-table-body">
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="column">
                <h1>Distribution of Tandem Repeats Length</h1>
                <div id="histogram"></div>
            </div>
        </div>


        <br>
            <br>

            <div class="homepage-container" style="margin-bottom: 1%;">
                <h1>Top 10 Organisms by Tandem Repeat Density</h1>
            </div>
            <div class="homepage-container">
                <table id="topten-organisms-table" class="display table table-striped table-hover dataTable"
                    style="table-layout: auto; width: 90%;" aria-describedby="example_info">
                    <thead>
                        <tr role="row" id="topten-organisms-table-header">
                            <th>Organism Name</th>
                            <th>Organism Domain</th>
                            <th>Short Tandem Repeats count</th>

                        </tr>
                    </thead>
                    <tbody id="topten-organisms-table-body">
                    </tbody>
                </table>
            </div>
    </div>

    <br>
    <br>

<div id="footer-container"></div>
</body>

<script src="js/components.js"></script>

<script>

    let group_avg_count = {};
    let group_avg_length = {}
    let group_avg_density = {}

 

    function transformData(res) {
        for (let lst of res) {
            group_avg_count[prettifyGroupName(lst[0])] = lst[1];
            group_avg_length[prettifyGroupName(lst[0])] = lst[2];
            group_avg_density[prettifyGroupName(lst[0])] = lst[3];
        }
    }



    function renderPies() {
        // Combine data into one array for easier iteration
        const datasets = [ group_avg_density];
        // Calculate total for each dataset
        const totals = datasets.map(data => Object.values(data).reduce((acc, val) => acc + val, 0));

        // SVG dimensions
        const width = 400;
        const height = 400;
        const radius = Math.min(width, height) / 2;

       // Define custom color scheme with four specified colors
        const customColorScale = d3.scaleOrdinal()
            .domain(Object.keys(group_avg_count))
            .range(["#FFC107", "#17A2B8", "#6C757D", "#E83E8C"]);


        // Function to create pie charts
        datasets.forEach((data, i) => {
            const svg = d3.select(`#chart${i + 1}`)
                .append("svg")
                .attr("width", width)
                .attr("height", height)
                .append("g")
                .attr("transform", `translate(${width / 2}, ${height / 2})`);

            // Create arcs for slices
            const pie = d3.pie()
                .sort(null)
                .value(d => d.value);

            const arc = d3.arc()
                .outerRadius(radius - 10)
                .innerRadius(0);

            const arcs = pie(Object.entries(data).map(([key, value]) => ({ key, value })));

            // Draw slices
            const paths = svg.selectAll("path")
                .data(arcs)
                .enter().append("path")
                .attr("fill", d => customColorScale(d.data.key))
                .attr("d", arc);


            paths.append("title")
                .text(d => `${d.data.key}: ${(d.data.value / totals[i] * 100).toFixed(1)}%`);

            paths.on("mouseover", function (d) {
                d3.select(this)
                    .transition()
                    .duration(100)
                    .attr("opacity", 0.7);

                const percent = (d.data.value / totals[i] * 100).toFixed(1);
                const tooltipText = `${d.data.key}: ${percent}%`;

                // Show tooltip
                tooltip.transition()
                    .duration(100)
                    .style("opacity", 0.9);

                tooltip.html(tooltipText)
                    .style("left", (d3.event.pageX + 10) + "px")
                    .style("top", (d3.event.pageY - 15) + "px");
            })
                .on("mouseout", function (d) {
                    d3.select(this)
                        .transition()
                        .duration(200)
                        .attr("opacity", 1);

                    // Hide tooltip
                    tooltip.transition()
                        .duration(500)
                        .style("opacity", 0);
                });

            // Legend data
            const legendData = Object.entries(data).map(([key, value]) => ({
                key,
                value: (value / totals[i] * 100).toFixed(1)
            }));

            

            // Add legend
            const legend = d3.select("#legend")
                .selectAll(".legend-item")
                .data(legendData)
                .enter().append("div")
                .attr("class", "legend-item")
                .on("click", function (event, d) {
                    const htmlContent = this.innerHTML;
                    let selected_organism = ''
                    domains.forEach(org => {
                        if (htmlContent.includes(prettifyGroupName(org))) location.href = `/stats_per_domain.html?domain=${org != "Viruses" ? org : "Virus"}`
                    })
                });


            legend.append("div")
                .style("width", "20px")
                .style("height", "20px")
                .style("background-color", d => customColorScale(d.key))
                .style("margin-top", "5px");

            legend.append("span")
                .text(d => `${d.key}`);
        });

        // Tooltip
        const tooltip = d3.select("body")
            .append("div")
            .attr("class", "tooltip")
            .style("opacity", 0);
    }



    function renderHistogramPercentage(data) {
        let total_count = 0;
        data.forEach(lst => total_count += lst[1]);
        let histogram_data = {}
        data.forEach(lst => { histogram_data[lst[0]] = lst[1]; })
        for (let i = 1; i <= 9; i++) {

            histogram_data[i] = divideToPercent(histogram_data[i], total_count);
        }

        
        const chartData = Object.entries(histogram_data).map(([length, percentage]) => ({
            length: parseInt(length),
            percentage: percentage
        }));

        // Set up chart dimensions
        const margin = { top: 30, right: 30, bottom: 70, left: 60 };
        const width = 600 - margin.left - margin.right;
        const height = 400 - margin.top - margin.bottom;

        // Create SVG element
        const svg = d3.select("#histogram")
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);



        // Create tooltip
        const tooltip = d3.select("body").append("div")
            .attr("class", "histogram-tooltip")
            .style("opacity", 0);

        // X axis
        const x = d3.scaleBand()
            .range([0, width])
            .domain(chartData.map(d => d.length))
            .padding(0.2);
        svg.append("g")
            .attr("transform", `translate(0,${height})`)
            .call(d3.axisBottom(x))
            .selectAll("text")
            .attr("transform", "translate(-10,0)rotate(-45)")
            .style("text-anchor", "end");

        // Y axis
        const y = d3.scaleLinear()
            .domain([0, d3.max(chartData, d => d.percentage)])
            .range([height, 0]);
        svg.append("g")
            .call(d3.axisLeft(y));

        // Bars
        svg.selectAll("mybar")
            .data(chartData)
            .join("rect")
            .attr("x", d => x(d.length))
            .attr("y", d => y(d.percentage))
            .attr("width", x.bandwidth())
            .attr("height", d => height - y(d.percentage))
            .attr("class", "bar")
            .on("mouseover", function (event, d) {
                tooltip.transition()
                    .duration(200)
                    .style("opacity", .9);
                tooltip.html(`Percentage: ${d.percentage}%`)
                    .style("left", (event.pageX) + "px")
                    .style("top", (event.pageY - 28) + "px");
            })
            .on("mouseout", function (d) {
                tooltip.transition()
                    .duration(500)
                    .style("opacity", 0);
            });

        // X axis label
        svg.append("text")
            .attr("class", "axis-label")
            .attr("text-anchor", "middle")
            .attr("x", width / 2)
            .attr("y", height + margin.bottom - 10)
            .text("Length");

        // Y axis label
        svg.append("text")
            .attr("class", "axis-label")
            .attr("text-anchor", "middle")
            .attr("transform", "rotate(-90)")
            .attr("y", -margin.left + 20)
            .attr("x", -height / 2)
            .text("Percentage");

        // Title
        svg.append("text")
            .attr("x", width / 2)
            .attr("y", -margin.top / 2)
            .attr("text-anchor", "middle")
            .style("font-weight", "bold")
            .html(`Short Tandem Repeat Length Distribution`)

        svg.append("foreignObject")
            .attr("x", 20) // Adjust to align with the text
            .attr("y", 0) // Adjust to align with the text
            .attr("width", 30)
            .attr("height", 30)
            .append("xhtml:div")
            .html('<i id="download-histogram" class="fa-solid fa-file-arrow-down"></i>');

        svg.selectAll("text")
            .style("fill", "white");
    }


    // Fetch calls

    $.ajax({
        url: `${backend_url}/statistics/domains`,
        method: 'GET',
        success: function (data) {
            data[3][0]="Viruses";
            transformData(data);
            renderPies();
        },
        error: function (xhr, status, error) {
            console.error('Error:', error);
        }
    });

    $.ajax({
        url: `${backend_url}/statistics/global/top_n_unit_sequences`,
        type: 'GET',
        success: function (response) {
            for (let i=0; i<response.length; i++){
                response[i][0]=response[i][0].toUpperCase()
            }
            topten_unit_table = new DataTable('#topten-unit-table',
                {
                    data: response,
                    paging: false,
                    searching: false,
                    ordering: false,
                    "bInfo": false
                });
        },
        error: function (xhr, status, error) {
            console.error('Error:', error);
        }
    });

    $.ajax({
        url: `${backend_url}/statistics/global/top_n_organisms_by_tandem_repeats_density`,
        type: 'GET',
        success: function (response) {
            let top_ten_organisms_rows = [];
            response.forEach(row => {
                const taxid = row[3];
                top_ten_organisms_rows.push([`<a href='https://www.ncbi.nlm.nih.gov/Taxonomy/Browser/wwwtax.cgi?mode=Info&id=${taxid}'>${row[0]}<a>`, prettifyGroupName(row[1]), denistyToMegabasePairs(row[2]) + " / Mb"])
            })
            topten_organisms_table = new DataTable('#topten-organisms-table',
                {
                    data: top_ten_organisms_rows,
                    paging: false,
                    searching: false,
                    ordering: false,
                    "bInfo": false
                });
        },
        error: function (xhr, status, error) {
            console.error('Error:', error);
        }
    });

    $.ajax({
        url: `${backend_url}/statistics/global/sru_distribution`,
        type: 'GET',
        success: function (response) {
            renderHistogramPercentage(response)

        },
        error: function (xhr, status, error) {
            console.error('Error:', error);
        }
    });




</script>

</html>